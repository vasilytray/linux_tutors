# Настройка сети ВМ в Virtual-Box

## Сетевые настройки VirtualBox

После установки Virtual Box зададим начальнае параметры сети среды виртуализации:

1. Перейдем в меню: Файл - Инструменты - Менеджер сетей или просто нашмем горячие клавиши **Ctrl+H**

![Меню перехода в менеджер сетей](/images/vbsettings-1.jpg)

2. Выберем вкладку "Виртуальные сети" и имеющийся VirtualBox Host-Only Ethernet Adapter

Можно конечно оставить все по умолчанию, но нам нужен понятный и конкретно настроенный сетевой 
интерфейс, поэтому нажмем "Свойства", а во вкладке "Адаптер" переключим режим в "Настроить адаптер вручную"
 - добавим IPv4 адрес: например 192.168.48.1 - это будет наш шлюз.
 - добавим IPv4 маску сети: например 255.255.255.0

Перейдем во вкладку DHCP сервер и выберем галку Включить сервер (это используем для ВМ, которые не будут настроены вручную а будут получать динамически IPv4 от нашего DHCP - сервера). настроим данные DHCP - сервера (пример приведен на картинке ниже).

![Настройки DHCP-сервера](/images/vbsettings-2.jpg)

3. Перейдем во вкладку **Сети NAT** и выбрав NatNetwork настроим Основные опции:
 - Имя оставим **NatNetwork**
 - IPv4 префикс: можем оставить как есть или задать  приватной сеть вручную, например 10.0.2.0/24
 - Включим DHCP-сервер выбрав соответсвующею галочку.

### Немного о NAT

Протокол NAT позволяет гостевой операционной системе (ОС виртуальной машины) выходить в Интернет, используя при этом частный IP, который не доступен со стороны внешней сети или же для всех машин локальной физической сети. Такая сетевая настройка позволяет посещать web-страницы, скачивать файлы, просматривать электронную почту. И все это, используя гостевую операционную систему. Однако извне невозможно напрямую соединиться с такой системой, если она использует NAT.

Принцип трансляции сетевых адресов заключается в следующем. Когда гостевая ОС отправляет пакеты на конкретный адрес удаленной машины в сети, сервис NAT, работающий под VirtualBox, перехватывает эти пакеты, извлекает из них сегменты, содержащие в себе адрес пункта отправки (IP-адрес гостевой операционной системы) и производит их замену на IP-адрес машины-хоста. Затем заново упаковывает их и отправляет по указанному адресу.

Например, в вашей домашней локальной сети хост и другие физические сетевые устройства имеют адреса в диапазоне, начинающемся с 192.168.х.х. В VirtualBox адаптеры, работающие по протоколу NAT, имеют IP-адреса в диапазоне, начинающемся с 10.0.2.1 и заканчивающемся 10.0.2.24. Такой диапазон называется под-сетью. Как правило, этот диапазон не используется для присвоения адресов устройствам в основной сети, поэтому такая система недоступна извне, со стороны хоста. Гостевая ОС может выполнять обновление программного обеспечения и web-серфинг, но остается невидимой для остальных "участников сети" в том числе и для самого хоста.

> Изначально виртуальные машины в **VirtualBox** создаются с сетевыми настройками ** Адаптер 1: (NAT)**

## Сетевые настройки Виртуальной машины

> **Рассмотрим задачу:** Создать ВМ с ОС Ubuntu 20.04 с возможностью доступа к виртуальной машине по ssh с хоста (с ПК на котором и развернут VirtualBox) для работы в VS Code.

### Первоначальная настройка ВМ (NAT) - для исходящих соединений

1. Создадим новую Виртуальную машину из образа дистрибутива Ubuntu с предустановленными параметрами.

После создания и запуска ВМ зайдем в терминал ВМ и попробуем проверить соединение с интернет:

```sh
ping 8.8.8.8
```
если исходящие паркеты проходят, то все хорошо, сеть есть и это работает предустановленный NAT.

![проверка исходящего соединения ping-ом](/images/vbsettings-3.jpg)

Можно обновить пакеты ОС например так:
```sh
apt update | apt upgrade -y
```

Но пока доступа к нашей виртуальной машине со стороны хоста нет.

Исправим эту ситуацию, выключим ВМ чтобы настроить ее сетевые интерфейсы:

```sh
shutdown now
```
Виртуальная машины выключиться.

### Настройка Виртуального адаптера ВМ

При подключении типа "Виртуальный адаптер" гостевые ОС (виртуальных машин) могут взаимодействовать между собой, а также с хостом. Но все это только внутри самой виртуальной машины VirtualBox. В этом режиме адаптер хоста использует свое собственное, специально для этого предназначенное устройство, которое называется **VirtualBox Host-Only Ethernet Adapter**. Также им создается подсеть и назначаются IP-адреса сетевым картам гостевых операционных систем. Гостевые ОС не могут взаимодействовать с устройствами, находящимися во внешней сети, так как они не подключены к ней через физический интерфейс. Режим "Виртуальный адаптер" предоставляет ограниченный набор служб, полезных для создания частных сетей под VirtualBox для ее гостевых ОС.

В отличие от других продуктов виртуализации, адаптер, работающий под протоколом NAT в VirtualBox, не может выступать в роли связующего моста между сетевым устройством по умолчанию на хостах. Поэтому невозможен прямой доступ извне к машинам, "спрятанным" за NAT - ни к программам, работающим на них; ни к данным, находящимся на самих хостах. 

Поэтому помимо NAT нам и потребуется **Виртуальный адаптер** 
Ранее при настройке сети VartualBox мы уже установили сетевые настройки **VirtualBox Host-Only Ethernet Adapter** и теперь подключим их для нашей ВМ.

1. В Oracle VirtualBox менеджере выберем настраиваемую ВМ.
2. Выберем значек **Настроить**.
3. В расширенных настройках ВМ выберем **Сеть**.
4. Далее выберем** Адаптер 2** (Адаптер 1 у нас использует NAT).
5. Включим сетевой адаптер.
6. Выберем тип подключения **Виртуальный адаптер**.

И сохраним наши настройки **ОК**

![Настройки сетевого адаптера 2](/images/vbsettings-4.jpg)

Теперь запустим ВМ и посмотрим сетевые настройки виртуальной машины:

```sh
ip a
```

![сетевые настройки ВМ](/images/vbsettings-5.jpg)

в результате на примере мы видим три сетевых адаптера:
- 1: lo: - это loopback самой виртуалки
- 2: enp0s3: с IPv4: 10.0.2.15/24 и причем он динамический - получен от Адаптера 1 (NAT)
- 3: enp0s8: с IPv4: 192.168.48.101/24 и причем он динамический - получен от Адаптера 2 (Виртуальный адаптер)

Отлично! у нас есть IP адрес виртуальной машины, доступный со стороны Хоста.
Проверим это, откроем на компьютере (хосте) терминал в системе или например в VS Code и проверим доступность айпи-адреса


```sh
ping 192.168.48.101
```

![проверка исходящего соединения c ВМ ping-ом](/images/vbsettings-6.jpg)

Сетевые настройки прошли успешно, НО! Т.к. IPv4: 192.168.48.101 - динамический и получен от DHCP-сервера, то при новой сессии ВМ может быть другим. Чтобы наша ВМ имела постоянный АйПи адрес для доступа с хоста, настроим статический IPv4. Мы уже видим что адрес IPv4: 192.168.48.101 - в сети выделен нашей ВМ и он не занят никем другим, возмем его в качестве статического адреса.

### Настройка статического адреса виртуальной машины.

В терминале виртуальной машины перейдем в режим супер-юзера:
```sh
sudo su
```
введем пароль польлзователя и получим root - права.

Теперь нам необходимо сконфигурировать наши сетевые настройки ВМ.

Для этого откроем конфигурационный файл Netplan-а

```sh
nano /etc/netplan/00-installer-config.yml
```

В открывшемся редакторе для адаптера enp0s8 сделаем изменения:

```yaml
network:
  enp0s8:
    dhcp4: no
    addresses: [ 192.168.48.101/24 ]
    gateway4: 192.168.48.1
    nameservers:
      addresses: [ 8.8.8.8, 8.8.4.4 ]
```

Теперь сохраняем настройки и далее проверим и применим их
1. Проверим наши настройки на ошибки:
```sh
netplan try
```
2. Применим наши настройки:
```sh
netplan apply
```

3. Теперь проверим настройки сети:

```sh
ip a
```

И увидим что настроенный нами адрес теперь ВМ прописан статически, а не получается от DHCP-сервера.

![настройки netplan](/images/vbsettings-7.jpg)

Далее нам необходимо настроить ssh и подключиться нашим VisualStudio Code.