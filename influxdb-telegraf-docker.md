# Запуск InfluxDB 2.0 и Telegraf с использованием Docker
---
Краткий перевод с сайта Influxdata для ознакомления с этапами настройки.

Первоначально [эта публикация](https://www.influxdata.com/blog/running-influxdb-2-0-and-telegraf-using-docker/) была опубликована в январе 2021 года, и чтобы сохранить ее актуальность, мы обновили ее в декабре 2022 года.

Код, связанный с этим блогом, можно найти в этом [репозитории](https://github.com/InfluxCommunity/InfluxDBv2_Telegraf_Docker) . - Исходник для установки связки InfluxDB 2.0 и Telegraf с использованием Docker.

## Оглавление

- Запуск Docker-контейнеров
- Эксплуатационные контейнеры
- Docker-композитор
- Подведение итогов

### Запуск Docker-контейнеров

Есть несколько способов взаимодействия с Docker и управления вашими контейнерами. Первый — использование dockerисполняемого файла для выдачи команд типа ``docker run`` и ``docker stop`` .

#### Докерные сети

Cначала мы настроим новую сеть Docker. Docker поставляется со встроенной сетью, к которой по умолчанию подключены все контейнеры, но создание новой сети для нашего развертывания InfluxDB 2.0-rc и Telegraf сохранит их изолированными, позволяя им при этом общаться друг с другом. Изоляция хороша для ряда вещей, но она может быть особенно полезна для запуска нескольких экземпляров стека для тестирования или разработки.

Мы создадим новую сеть с помощью следующей команды:
```sh
$ docker network create --driver bridge influxdb-telegraf-net
```
Который создает новую сеть с использованием драйвера моста и дает ей имя **influxdb-telegraf-net**.

Когда мы выполним команду docker run для запуска контейнера, мы добавим следующий аргумент для его подключения к нашей недавно созданной сети:
```sh
--network influxdb-telegraf-net
```

Мы также захотим открыть порт из контейнера на хост Docker, чтобы мы могли общаться с приложениями в наших контейнерах из внешнего мира. База данных InfluxDB v2 по умолчанию взаимодействует через порт 8086. Используйте флаг публикации --publishили -pи добавьте следующие две строки в нашу команду docker run, чтобы открыть порт:
```sh
-p 8086:8086
```
#### Постоянное хранение

Далее нам нужно будет принять некоторые решения о том, где мы хотим хранить наши файлы конфигурации и где мы будем хранить данные контейнеров, которым они нужны.

Продолжая строить нашу команду запуска InfluxDB, база данных ожидает, что у нее будет доступ к одному расположению файла на Linux, ``/root/.influxdb2``, где она хранит свои данные и конфигурации.

Мы собираемся смонтировать локальные папки хоста в эти расположения в контейнере, добавив флаг томов --volumeили -v, к docker run. Если хотите, вы можете позволить Docker управлять томом за вас, но привязка папки на локальной машине гарантирует, что мы сможем получить доступ к данным из нашей хостовой ОС.

Точки привязки на хосте Docker будут различаться в зависимости от машины, на которой вы работаете. Для примера представим, что у нас есть папка в домашнем каталоге **/home** пользователя с именем **influx**, и две подпапки внутри нее с именами **data** и **config**. Мы предоставим следующие аргументы для монтирования этих двух папок внутри контейнера:
```sh
-v  /home/influx:/root/.influxdb2
```

#### Собираем все вместе: запуск InfluxDB в контейнере по сети

Нам просто нужно добавить еще несколько вещей в нашу ``docker run`` команду. Мы собираемся использовать ``-d`` флаг для запуска контейнера в «отсоединенном» режиме, который запускает его в фоновом режиме, и мы собираемся дать ему имя с ``--name`` параметром. Наконец, мы запустим самую последнюю версию контейнера **influxdb**

```sh
docker run -d --name=influxdb \
 -p 8086:8086 \
 -v  /home/influx:/root/.influxdb2 \
      --net=influxdb-telegraf-net \
      influxdb:2.0
```
После успешного выполнения команды вы должны увидеть сгенерированный идентификатор контейнера, например:
```
8d868d437d5444c4ce0db04f208939843113db651a3729ce3c924bd11df19d38
```
Далее мы запустим контейнер **Telegraf** аналогичным образом. Но перед этим нам нужно настроить наш экземпляр **InfluxDB**

#### Настройка InfluxDB 2.0

Самый простой способ настроить экземпляр **InfluxDB 2.0-rc** — через пользовательский интерфейс. Посетите ```http://localhost:8086```, чтобы завершить настройку и собрать необходимые учетные данные для авторизации. Чтобы записать данные в **InfluxDB** с помощью **Telegraf**, вам нужно:

- Соберите название вашей организации
- Создайте целевой сегмент
- Соберите токен аутентификации

Вы также можете завершить настройку с помощью **InfluxDB CLI** . Чтобы запустить CLI внутри самого контейнера, вам нужна команда. Она позволяет вам запустить интерактивный сеанс. Укажите аргументы и для создания интерактивного сеанса и выделения псевдо-TTY соответственно. Команда настройки influx позволяет вам настроить экземпляр InfluxDB интерактивно с помощью CLI. ``docker exec-io-t``

Используйте следующую команду для запуска **influx CLI** в нашем **influxdb** контейнере:
```sh
$ docker exec -it influxdb influx setup
```


## Сертификаты Let's Encrypt для InfluxDB (не в докере)

Запуск influxdс флагами TLS
Чтобы запустить InfluxDB с флагами командной строки TLS, введите следующую команду с путями к файлам ключей и сертификатов:

```sh
influxd \
  --tls-cert="/etc/letsencrypt/live/influx.95g.ru/cert1.crt" \
  --tls-key="/etc/letsencrypt/live/influx.95g.ru/privkey1.key" > /var/log/influxdb.log 2>&1 &
```